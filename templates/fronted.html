<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../static/css/swiper.min.css">
    <link rel="stylesheet" href="../static/css/reset.css">
    <link rel="stylesheet" href="../static/css/main.css">
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.min.js"></script> -->
    <script src="../static/js/jbh/jquery-3.4.1.min.js"></script>
    <script src="../static/js/jbh/swiper.min.js"></script>
    <script src="../static/js/jbh/zrender.min.js"></script>

    <title></title>
</head>
<body>
    <div class="container">
        <div id="main" style="width:100%;height:100%;"></div>
    </div>
    <script src="../static/js/jbh/draw.js"></script>
    <script>
        var domain = 'http://47.103.66.5:5000'
        var arrString = []
        
        $.ajax({
           url:domain+'/get_all_data',
           type:'get',
           success:function(result){
                var res = JSON.parse(result)
                if(res.code=='200'){
                    var batchTime = res.data.all_batch_speed
                    //getData(1)
                }
           }
       })
        function getData(batch,speed){
            $.ajax({
            url:domain+'/get_drop_list_data?batch='+batch,
            type:'get',
            success:function(result){
                    $('.layer').hide()
                    var res = JSON.parse(result)
                    if(res.code=='200'){
                        //console.log(arrString.length!=0)
                        if(arrString.length!=0){
                            if(JSON.stringify(arrString)!=JSON.stringify(res.data)){
                                drawFunc.init(res.data)
                                arrString = res.data
                            }     
                        }else{
                            drawFunc.init(res.data)
                            arrString = res.data
                        } 
                    }else{
                        alert(res.message)
                    }
                }
            })
        }
        /*
        * 轮询查数据
        */ 
        var batch = 0
       $.ajax({
           url:domain+'/get_all_data',
           type:'get',
           success:function(result){
                var res = JSON.parse(result)
                if(res.code=='200'){
                    var batchNum = res.data.all_batch_num
                    var batchTime = res.data.all_batch_speed
                    //var batch = 1
                    getData(1)
                    var reflashFirst = setInterval(()=>{
                        getData(1)
                    },2000)
                    var timer = setInterval(function(){
                        clearInterval(reflashFirst)
                        batch++
                        console.log(batch)
                        reflashFirst = setInterval(()=>{
                            console.log(batch+1)
                            getData(batch+1)
                        },2000)
                        getData(batch)
                        if(batch>=batchNum){
                            batch=0
                        }
                    },batchTime*1000)
                }
           }
       })
    </script>
</body>
</html>